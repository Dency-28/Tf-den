name: Terraform CI/CD (Testing)

on:
  pull_request:
    branches:
      - testing
  issue_comment:
    types: [created]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: read

jobs:
  terraform:
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      (contains(github.event.comment.body, '/plan') ||
       contains(github.event.comment.body, '/apply')))
    runs-on: ubuntu-latest
    name: Terraform Plan & Apply (Testing)

    env:
      AWS_REGION: us-east-1

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # BACKEND SETUP
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Terraform Init (Backend)
        working-directory: backend
        run: terraform init

      - name: Terraform Plan (Backend)
        if: contains(github.event.comment.body, '/plan')
        id: backend_plan
        working-directory: backend
        run: terraform plan -no-color
        continue-on-error: true

      - name: Post Backend Plan Comment
        if: contains(github.event.comment.body, '/plan')
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: backend-plan
          message: |
            ### ðŸ§­ Terraform Backend Plan Result
            ```
            ${{ steps.backend_plan.outputs.stdout }}
            ```

      - name: Terraform Apply (Backend)
        if: contains(github.event.comment.body, '/apply')
        id: backend_apply
        working-directory: backend
        run: terraform apply -auto-approve -no-color
        continue-on-error: true

      - name: Post Backend Apply Comment
        if: contains(github.event.comment.body, '/apply')
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: backend-apply
          message: |
            ### ðŸš€ Terraform Backend Apply Result
            ```
            ${{ steps.backend_apply.outputs.stdout }}
            ```

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # INFRA SETUP
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Terraform Init (Infra)
        working-directory: infra
        run: terraform init

      - name: Terraform Plan (Infra)
        if: contains(github.event.comment.body, '/plan')
        id: infra_plan
        working-directory: infra
        run: terraform plan -no-color
        continue-on-error: true

      - name: Post Infra Plan Comment
        if: contains(github.event.comment.body, '/plan')
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: infra-plan
          message: |
            ### ðŸ§­ Terraform Infra Plan Result
            ```
            ${{ steps.infra_plan.outputs.stdout }}
            ```

      - name: Terraform Apply (Infra)
        if: contains(github.event.comment.body, '/apply')
        id: infra_apply
        working-directory: infra
        run: terraform apply -auto-approve -no-color
        continue-on-error: true

      - name: Post Infra Apply Comment
        if: contains(github.event.comment.body, '/apply')
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: infra-apply
          message: |
            ### ðŸš€ Terraform Infra Apply Result
            ```
            ${{ steps.infra_apply.outputs.stdout }}
            ```
