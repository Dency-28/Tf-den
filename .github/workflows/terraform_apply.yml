name: Terraform CI/CD (Testing Branch)

on:
  pull_request:
    branches: [ testing, main ]
  issue_comment:
    types: [ created ]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  terraform:
    name: Terraform Plan & Apply
    runs-on: ubuntu-latest

    env:
      AWS_REGION: us-east-1
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.8

      # Detect comment trigger
      - name: Detect comment trigger
        id: comment
        if: github.event_name == 'issue_comment'
        run: |
          comment="${{ github.event.comment.body }}"
          if [[ "$comment" == "/plan" ]]; then
            echo "run_plan=true" >> $GITHUB_ENV
          elif [[ "$comment" == "/apply" ]]; then
            echo "run_apply=true" >> $GITHUB_ENV
          fi

      # âœ… PLAN â€” only runs infra (never touches backend)
      - name: Terraform Plan (Infra only, no backend)
        if: env.run_plan == 'true'
        run: |
          echo "ðŸŸ¡ Skipping backend creation. Running plan for infra only."
          terraform -chdir=terraform_infra init -backend=false -input=false
          terraform -chdir=terraform_infra plan -input=false -no-color > plan_output.txt || true
          cat terraform_infra/plan_output.txt || cat plan_output.txt

      # âœ… APPLY â€” runs backend first, then infra
      - name: Terraform Apply
        if: env.run_apply == 'true'
        run: |
          echo "ðŸŸ¢ Creating backend (S3 + DynamoDB)..."
          terraform -chdir=terraform_backend init -input=false
          terraform -chdir=terraform_backend apply -auto-approve

          echo "ðŸŸ¢ Applying infra with backend..."
          terraform -chdir=terraform_infra init -reconfigure -input=false
          terraform -chdir=terraform_infra apply -auto-approve
