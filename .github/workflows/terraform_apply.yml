name: Terraform CI/CD (Testing Branch)

on:
  pull_request:
    branches: [ testing, main ]
  issue_comment:
    types: [ created ]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  terraform:
    name: Terraform Plan & Apply
    runs-on: ubuntu-latest

    env:
      AWS_REGION: us-east-1
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.8

      # ✅ Identify comment trigger
      - name: Check comment body
        id: check_comment
        if: github.event_name == 'issue_comment'
        run: |
          comment="${{ github.event.comment.body }}"
          if [[ "$comment" == "/plan" ]]; then
            echo "run_plan=true" >> $GITHUB_ENV
          elif [[ "$comment" == "/apply" ]]; then
            echo "run_apply=true" >> $GITHUB_ENV
          fi

      # ✅ Run PLAN (no backend creation)
      - name: Terraform Plan (infra only)
        if: env.run_plan == 'true'
        run: |
          echo "Running Terraform Plan for infra (without backend)..."
          terraform -chdir=terraform_infra init -backend=false -input=false
          terraform -chdir=terraform_infra plan -input=false -no-color > plan_output.txt || true
          echo "PLAN OUTPUT BELOW:"
          cat terraform_infra/plan_output.txt || cat plan_output.txt

      # ✅ Run APPLY (create backend + apply infra)
      - name: Terraform Apply
        if: env.run_apply == 'true'
        run: |
          echo "Creating backend (S3 + DynamoDB)..."
          terraform -chdir=terraform_backend init -input=false
          terraform -chdir=terraform_backend apply -auto-approve

          echo "Running Terraform Apply for infra..."
          terraform -chdir=terraform_infra init -reconfigure -input=false
          terraform -chdir=terraform_infra apply -auto-approve

