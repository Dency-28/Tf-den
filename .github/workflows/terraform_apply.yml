name: Terraform Comment Trigger (Main)

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: read
  issues: read

jobs:
  trigger:
    if: |
      github.event.issue.pull_request != null &&
      (contains(github.event.comment.body, '/plan') || contains(github.event.comment.body, '/apply'))
    runs-on: ubuntu-latest

    steps:
      - name: Extract PR branch name
        id: extract
        run: |
          pr_url="${{ github.event.issue.pull_request.url }}"
          branch=$(gh api "$pr_url" --jq '.head.ref')
          echo "branch=$branch" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger Terraform workflow on testing branch
        run: |
          gh workflow run terraform.yml \
            --ref "${{ steps.extract.outputs.branch }}" \
            -f comment="${{ github.event.comment.body }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
